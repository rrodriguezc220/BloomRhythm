<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Bloom Watch</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/HackathonBloomWatch.styles.css" asp-append-version="true" />
    <link rel="icon" href="~/img/icon/icono.png" type="image/x-icon" />




    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>





    @*font-awesome*@
    <link rel="stylesheet" href="~/lib/font-awesome/css/all.css" />

    @*Leaflet*@
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>
<body>
    <header>
        <nav class="navbar navbar-expand-sm navbar-toggleable-sm navbar-dark bg-bunker shadow-sm mb-3">
            <div class="container-fluid">
                <!-- LOGO -->
                <a class="navbar-brand d-flex align-items-center" asp-area="" asp-controller="Home" asp-action="Index">
                    <img src="~/img/icon/icono.png" alt="BloomRhythm" style="height:40px;" class="me-2">
                    <span class="text-zumthor fw-bold d-none d-md-inline">BloomRhythm</span>
                </a>

                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                        data-bs-target="#navbarContent" aria-controls="navbarContent"
                        aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="navbarContent">
                    <ul class="navbar-nav me-auto mb-2 mb-sm-0">
                        <li class="nav-item">
                            <a class="nav-link text-zumthor" asp-area="" asp-controller="Home" asp-action="Index">
                                <i class="fa-solid fa-house me-1"></i>
                                Home
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-zumthor" asp-area="" asp-controller="Mapa" asp-action="Index">
                                <i class="fa-solid fa-map-location-dot me-1"></i>
                                Interactive Map
                            </a>
                        </li>
                    </ul>

                    <!-- Botones de la derecha -->
                    <div class="d-flex align-items-center gap-2">
                        <!-- Botón Chatbot -->
                        <button class="btn btn-outline-light btn-sm rounded-pill px-3" onclick="openChatbot()" title="Ask BloomBot">
                            <i class="fa-solid fa-robot me-1"></i>
                            <span class="d-none d-lg-inline">BloomBot</span>
                            <span class="d-inline d-lg-none">AI</span>
                        </button>

                        <!-- Indicador de estado (opcional) -->
                        <div class="vr bg-mako d-none d-sm-block" style="height: 24px;"></div>

                        <span class="badge bg-salem rounded-pill px-3 py-2 d-none d-sm-inline-block">
                            <i class="fa-solid fa-satellite-dish me-1"></i>
                            Live Data
                        </span>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <div class="container-fluid">
        <main role="main" class="pb-3">
            @RenderBody()
        </main>
    </div>

    <footer class="footer text-muted">
        <div class="container text-center">
            &copy; 2025 - <span class="text-cream-can">BloomRhythm</span> - Todos los derechos reservados
        </div>
    </footer>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>

    @* SweerAlert2 *@
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    @* Chart.js para dashboards *@
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.0/dist/chart.umd.min.js"></script>

    @await RenderSectionAsync("Scripts", required: false)
<!-- 💬 CHATBOT FLOTANTE -->
    <div id="chatbot-container" class="position-fixed end-0 m-4" style="z-index: 1050; bottom: 70px;">
    <!-- Botón flotante -->
        <button id="chatbot-toggle" class="btn rounded-circle shadow-lg d-flex align-items-center justify-content-center" onclick="toggleChatbot()">
            <i class="fas fa-comments fa-lg"></i>
        </button>

    <!-- Ventana del chat -->
    <div id="chatbot-window" class="card shadow-lg d-none mt-3">
        <!-- Encabezado -->
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><strong>Bloom Bot <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-robot"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 4m0 2a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v4a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2z" /><path d="M12 2v2" /><path d="M9 12v9" /><path d="M15 12v9" /><path d="M5 16l4 -2" /><path d="M15 14l4 2" /><path d="M9 18h6" /><path d="M10 8v.01" /><path d="M14 8v.01" /></svg></strong></span>
                <button id="chatbot-close" class="btn btn-sm" onclick="closeChatbot()">&times;</button>
        </div>

        <!-- Cuerpo -->
        <div id="chatbot-messages" class="card-body overflow-auto">
            <div class="bot-message">
                Hola, ¿en qué puedo ayudarte?
            </div>
        </div>

        <!-- Pie -->
        <div class="card-footer">
            <form id="chatbot-form" class="d-flex align-items-center gap-2">
                <input id="chatbot-input" type="text" class="form-control" placeholder="Escribe un mensaje..." />
                <button type="submit" class="btn"><i class="fas fa-paper-plane"></i></button>
            </form>
        </div>
    </div>
</div>

<!-- 🎨 ESTILOS PERSONALIZADOS -->
<style>
    /* Botón flotante */
    #chatbot-toggle {
        width: 56px;
        height: 56px;
        background-color: #3d444d;
        border: none;
        color: #fff;
        transition: all 0.3s ease;
    }

    #chatbot-toggle:hover {
        background-color: #4e5963;
        transform: scale(1.1);
    }

    /* Ventana general */
    #chatbot-window {
        width: 700px;
        height: 630px;
        border: 1px solid #3d444d;
        background-color: #0d1117;
        border-radius: 12px;
        overflow: hidden;
    }

    /* Encabezado */
    #chatbot-window .card-header {
        background-color: #151b23;
        color: #fff;
        border-bottom: 1px solid #3d444d;
        padding: 10px 15px;
        font-size: 15px;
    }

    #chatbot-close {
        background: transparent;
        border: none;
        color: #fff;
        font-size: 20px;
        line-height: 1;
        transition: color 0.2s;
    }

    #chatbot-close:hover {
        color: #999;
    }

    /* Mensajes */
    #chatbot-messages {
        height: 370px;
        background: linear-gradient(180deg, #0d1117 0%, #151b23 100%);
        color: #e6edf3;
        padding: 15px;
        font-size: 14px;
    }

    .bot-message,
    .user-message {
        padding: 10px 14px;
        border-radius: 10px;
        margin-bottom: 10px;
        max-width: 80%;
        word-wrap: break-word;
    }

    .bot-message {
        background-color: #3d444d;
        color: #fff;
        align-self: flex-start;
    }

    .user-message {
        background-color: #1f6feb;
        color: #fff;
        margin-left: auto;
        text-align: right;
    }

    /* Pie */
    #chatbot-window .card-footer {
        background-color: #151b23;
        border-top: 1px solid #3d444d;
        padding: 10px;
    }

    #chatbot-input {
        background-color: #0d1117;
        border: 1px solid #3d444d;
        color: #fff;
    }

    #chatbot-input::placeholder {
        color: #a1a1a1;
    }

    #chatbot-form .btn {
        background-color: #3d444d;
        color: #fff;
        border: none;
        transition: all 0.2s ease;
    }

    #chatbot-form .btn:hover {
        background-color: #4e5963;
    }
</style>

<!-- ⚙️ LÓGICA DEL CHATBOT -->
    <!-- ⚙️ FUNCIONES GLOBALES DEL CHATBOT -->
    <script>
        // Función global para abrir el chatbot (puede ser llamada desde cualquier lugar)
        function openChatbot() {
            const chatWindow = document.getElementById("chatbot-window");
            const toggleBtn = document.getElementById("chatbot-toggle");

            chatWindow.classList.remove("d-none");
            toggleBtn.classList.add("d-none");
        }

        // Función global para cerrar el chatbot
        function closeChatbot() {
            const chatWindow = document.getElementById("chatbot-window");
            const toggleBtn = document.getElementById("chatbot-toggle");

            chatWindow.classList.add("d-none");
            toggleBtn.classList.remove("d-none");
        }

        // Función para toggle (abrir/cerrar)
        function toggleChatbot() {
            const chatWindow = document.getElementById("chatbot-window");

            if (chatWindow.classList.contains("d-none")) {
                openChatbot();
            } else {
                closeChatbot();
            }
        }
    </script>

    <!-- ⚙️ LÓGICA DEL CHATBOT -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const form = document.getElementById("chatbot-form");
            const input = document.getElementById("chatbot-input");
            const messages = document.getElementById("chatbot-messages");

            // Enviar mensaje
            form.addEventListener("submit", async (e) => {
                e.preventDefault();
                const text = input.value.trim();
                if (!text) return;

                addMessage(text, "user");
                input.value = "";

                addMessage("Procesando...", "bot");

                try {
                    const response = await fetch("/api/chat/ask", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ message: text })
                    });

                    if (!response.ok) throw new Error("Error al conectar con el servidor.");

                    const data = await response.json();
                    replaceLastBotMessage(data.reply || "No obtuve respuesta.");
                } catch (error) {
                    replaceLastBotMessage("⚠️ Error: " + error.message);
                }
            });

            function addMessage(text, role) {
                const msg = document.createElement("div");
                msg.className = role === "user" ? "user-message" : "bot-message";

                if (role === "bot") {
                    msg.innerHTML = marked.parse(text);
                } else {
                    msg.textContent = text;
                }

                messages.appendChild(msg);
                messages.scrollTop = messages.scrollHeight;
            }

            function replaceLastBotMessage(newText) {
                const botMsgs = messages.querySelectorAll(".bot-message");
                if (botMsgs.length) {
                    botMsgs[botMsgs.length - 1].innerHTML = marked.parse(newText);
                }
                messages.scrollTop = messages.scrollHeight;
            }
        });
    </script>


</body>
</html>
